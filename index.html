<html>
    <head>
        <!-- Load plotly.js into the DOM -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
        <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
        <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
    </head>

    <body style="height: 100%; margin: 0;">
        <div id='map' style="min-height: 100%;"></div>
        <script>
            const main = async () => {
                const unpack = (rows, key) => rows.map(row => row[key])
                const status_map = ["functional", "non functional", "functional needs repair"]
                const category_color = ["green", "red", "yellow"]
                const center = {
                    longitude: 34.077427,
                    latitude: -5.706033,
                }

                try {
                    const stations = await d3.csv("data_for_vis.csv")

                    console.log("stations", stations)
                    
                    var data = [
                        {
                            type: "scattermapbox",
                            text: unpack(stations, "status_group").map(category => status_map[category]),
                            lon: unpack(stations, "longitude"),
                            lat: unpack(stations, "latitude"),
                            marker: { 
                                color: unpack(stations, "status_group").map(category => category_color[category]),
                                size: 5,
                                opacity: 0.5
                            }
                        },
                    ];

                    const layout = {
                        dragmode: "zoom",
                        mapbox: { style: "open-street-map", center: { lat: center.latitude, lon: center.longitude }, zoom: 6 },
                        margin: { r: 0, t: 0, b: 0, l: 0 },
                        autosize: true,
                        showlegend: true,
                    };


                    const plot = await Plotly.newPlot("map", data, layout)

                    plot.on('plotly_click', (data) => {
                        console.log(data)
                        alert(`Clicked on ${data.points[0].text} pump`)
                    })

                } catch (err) {
                    console.log("error", err)
                }
            }

            main()
        </script>
    </body>
</html>
