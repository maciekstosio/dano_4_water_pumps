<html>
    <head>
        <!-- Load plotly.js into the DOM -->
        <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
        <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
        <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
    </head>

    <body>
        <div id='map'></div>
        <script>
            const main = async () => {
                const unpack = (rows, key) => rows.map(row => row[key])

                const status_map = ["functional", "non functional", "functional needs repair"]

                const category_color = ["green", "red", "yellow"]

                try {
                    const stations = await d3.csv("data_for_vis.csv")

                    console.log("stations", stations)
                    
                    var data = [
                        {
                            type: "scattermapbox",
                            text: unpack(stations, "status_group").map(category => status_map[category]),
                            lon: unpack(stations, "longitude"),
                            lat: unpack(stations, "latitude"),
                            marker: { 
                                color: unpack(stations, "status_group").map(category => category_color[category]),
                                size: 5,
                                opacity: 0.5
                            }
                        },
                    ];

                    const layout = {
                        dragmode: "zoom",
                        mapbox: { style: "light", center: { lat: stations[0].latitude, lon: stations[0].longitude }, zoom: 6 },
                        margin: { r: 0, t: 0, b: 0, l: 0 },
                        autosize: false,
                        width: 1600,
                        height: 800,
                        showlegend: false,
                    };
        
                    Plotly.setPlotConfig({
                        mapboxAccessToken: "pk.eyJ1IjoibWFjaWtlcmEiLCJhIjoiY2s5Yms2czhnMDRvdTNtczN4dzV2YjhubSJ9.9fzPyd3DeeVGNZ2SsuE2bQ"
                    })

                    Plotly.newPlot("map", data, layout);                
                } catch (err) {
                    console.log("error", err)
                }
            }

            main()
        </script>
    </body>
</html>